<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seca Ayuno - Dashboard</title>

    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #4ade80;
            --danger: #f87171;
            --grid-color: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-box {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .login-box input {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--grid-color);
            background: var(--bg-dark);
            color: white;
            margin-bottom: 10px;
            width: 200px;
        }

        .login-box button {
            background: var(--accent);
            color: var(--bg-dark);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            display: none;
            /* Hidden until login */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--grid-color);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--grid-color);
        }

        .kpi-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .chart-section {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--grid-color);
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .refresh-btn {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--accent);
            color: var(--bg-dark);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text-secondary);
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--grid-color);
        }

        th {
            color: var(--text-primary);
        }
    </style>
</head>

<body>

    <!-- Login Screen -->
    <div class="login-overlay" id="loginScreen">
        <div class="login-box">
            <h2>Acceso Restringido</h2>
            <input type="password" id="passwordInput" placeholder="Contrase√±a">
            <button onclick="checkPassword()">Entrar</button>
            <p id="loginError" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px; display: none;">
                Contrase√±a incorrecta</p>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-container" id="dashboardContent">
        <div class="header">
            <h1>Seca Ayuno Analytics</h1>
            <button class="refresh-btn" onclick="fetchData()">üîÑ Actualizar</button>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">Visitas Totales</div>
                <div class="kpi-value" id="totalVisits">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Finalizados</div>
                <div class="kpi-value" id="totalCompleted">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Taxa de Convers√£o</div>
                <div class="kpi-value" id="conversionRate">-%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Abandono M√©dio (Step)</div>
                <div class="kpi-value" id="avgDropoff">-</div>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-header">
                <h3>Funil de Reten√ß√£o (Passo a Passo)</h3>
            </div>
            <div style="height: 400px;">
                <canvas id="funnelChart"></canvas>
            </div>
        </div>

        <div class="chart-section">
            <h3>√öltimas Sess√µes</h3>
            <div style="overflow-x: auto;">
                <table id="sessionsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Data</th>
                            <th>Etapa Final</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://bwpjmowuqkwogbtnheyp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3cGptb3d1cWt3b2didG5oZXlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNTc5MjEsImV4cCI6MjA4NTczMzkyMX0.RFSrtexhbic7fTn51gTFuJlmSuo5-9Ciyp367f8I_8A';
        const DASH_PASSWORD = "admin"; // Simple client-side protection

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Security Check
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === DASH_PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                fetchData();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // Allow Enter key for password
        document.getElementById('passwordInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') checkPassword();
        });

        // Data Fetching
        async function fetchData() {
            // Fetch all sessions (Limit 1000 for demo)
            const { data, error } = await supabase
                .from('quiz_sessions')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(1000);

            if (error) {
                console.error('Error fetching data:', error);
                alert('Erro ao carregar dados do Supabase');
                return;
            }

            processData(data);
        }

        function processData(sessions) {
            // 1. KPIs
            const total = sessions.length;
            const completed = sessions.filter(s => s.completed).length;
            const rate = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;

            // Average dropoff step
            const totalStepsSum = sessions.reduce((acc, curr) => acc + curr.current_step, 0);
            const avgStep = total > 0 ? Math.round(totalStepsSum / total) : 0;

            document.getElementById('totalVisits').textContent = total;
            document.getElementById('totalCompleted').textContent = completed;
            document.getElementById('conversionRate').textContent = rate + '%';
            document.getElementById('avgDropoff').textContent = avgStep;

            // 2. Funnel Chart Data
            // We need to know how many people passed through EACH step.
            // If a user is at step 10, they passed through 1..9.
            const totalSteps = 42;
            const stepCounts = new Array(totalSteps + 1).fill(0); // Index 1 to 42

            sessions.forEach(session => {
                // For each session, increment all steps up to current_step
                for (let i = 1; i <= Math.min(session.current_step, totalSteps); i++) {
                    stepCounts[i]++;
                }
            });

            // Prepare Chart Data (remove index 0)
            const labels = [];
            const dataPoints = [];
            for (let i = 1; i <= totalSteps; i++) {
                labels.push(`Step ${i}`);
                dataPoints.push(stepCounts[i]);
            }

            renderChart(labels, dataPoints);
            renderTable(sessions.slice(0, 10)); // Show last 10
        }

        let funnelChartInstance = null;

        function renderChart(labels, data) {
            const ctx = document.getElementById('funnelChart').getContext('2d');

            if (funnelChartInstance) {
                funnelChartInstance.destroy();
            }

            funnelChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Usu√°rios Ativos',
                        data: data,
                        backgroundColor: '#4ade80',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Horizontal Layout
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.raw} usu√°rios`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        function renderTable(sessions) {
            const tbody = document.querySelector('#sessionsTable tbody');
            tbody.innerHTML = '';

            sessions.forEach(s => {
                const date = new Date(s.created_at).toLocaleString('pt-BR');
                const status = s.completed ?
                    '<span style="color: #4ade80">Conclu√≠do</span>' :
                    '<span style="color: #f87171">Abandono</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span title="${s.id}">${s.id.slice(0, 8)}...</span></td>
                    <td>${date}</td>
                    <td>${s.current_step}</td>
                    <td>${status}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>

</html>